<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta charset="utf-8"></meta>
    <link rel="import" href="bower_components/polymer/polymer.html">
  </head>

  <body>
    <dom-module id="magi-revolver">
      <template>
        <div id="revolverarea">
          <content></content>
        </div>

        <style>
          .magi-revolver {
              overflow: hidden;
          }
        </style>
      </template>

      <script>
        Polymer({
          is: "magi-revolver",
          attached: function(e) {
            var images = document.querySelectorAll('magi-revolver img');
            for (i=0; i < images.length; i++) {
              initializeRotable(images[i]);
            }
          }
        });

        function initializeRotable(node) {
          node.rotation = 0.0;
          node.startDirection = 0.0;
          node.lastDirection = 0.0;

          node.addEventListener("mousemove", handleRevolverMove);
          node.addEventListener("mousedown", handleRevolverDown);
          node.addEventListener("mouseup", handleRevolverUpOut);
          node.addEventListener("mouseout", handleRevolverUpOut);
        }

        var rotating = 0;

        function handleRevolverDown(event) {
          console.log("Start rotation on: " + this.src + " at " + event.clientX);
          this.startDirection = calculateDirection(this, event);
          rotating = 1;
          event.preventDefault();
          event.stopPropagation();
        }

        function handleRevolverUpOut(event) {
          console.log("End rotation on: " + this.src + " at " + event.clientX);
          this.rotation = (this.lastDirection + 360) % 360;

          rotating = 0;
          event.preventDefault();
          event.stopPropagation();
        }

        function handleRevolverMove(event) {
          if (rotating) {
            var mouseDirection = calculateDirection(this, event);
            this.lastDirection = this.rotation + mouseDirection - this.startDirection;

            rotate(this, this.lastDirection);
            console.log("Drag on: " + this.src + " at " + this.lastDirection);
          }
          event.preventDefault();
          event.stopPropagation();
        }

        function calculateDirection(element, event) {
          var posx = event.clientX - element.x;
          var posy = event.clientY - element.y;
          var x = posx - element.clientWidth / 2;
          var y = posy - element.clientHeight / 2;
          return Math.atan2(y, x) * (180/Math.PI);
        }

        function rotate(element, rotation) {
           element.style =
                 "-moz-transform:rotate(" + rotation + "deg); " +
                 "-webkit-transform:rotate(" + rotation + "deg); " +
                 "-ms-transform:rotate(" + rotation + "deg); "
        }
      </script>
    </dom-module>
  </body>
</html>
