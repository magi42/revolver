<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta charset="utf-8"></meta>
    <link rel="import" href="bower_components/polymer/polymer.html">
  </head>

  <body>
    <dom-module id="magi-revolver">
      <template>
        <div id="revolverarea" on-mousedown="mouseDown" on-mousemove="mouseMove" on-mouseout="mouseUpOut" on-mouseup="mouseUpOut">
          <content></content>
        </div>

        <style>
          :host {
              overflow: hidden;
          }
        </style>
      </template>

      <script>
        Polymer({
          is: "magi-revolver",
          attached: function(e) {
            console.log("Initializing " + this)

            this.rotating = 0;
            this.rotation = 0.0;
            this.startDirection = 0.0;
            this.lastDirection = 0.0;

            console.log("Initialized " + this)
          },

          mouseDown: function(event) {
            console.log("MOUSEDOWN on " + this)
            this.startDirection = calculateDirection(this, event);
            this.rotating = 1;
            event.preventDefault();
            event.stopPropagation();
          },

          mouseMove: function(event) {
            if (this.rotating) {
              console.log("Dragging " + this.$.revolverarea.clientTop + " event " + event.clientX)
              var mouseDirection = calculateDirection(this.$.revolverarea, event);
              this.lastDirection = this.rotation + mouseDirection - this.startDirection;
              console.log("Dragging " + this.localName + " to rotateX(" + this.lastDirection + "deg)")

              this.transform("rotate(" + this.lastDirection + "deg)", this.$.revolverarea);
            }
            event.preventDefault();
            event.stopPropagation();
          },

          mouseUpOut: function(event) {
            console.log("MOUSEUP/OUT")
            this.rotation = (this.lastDirection + 360) % 360;

            this.rotating = 0;
            event.preventDefault();
            event.stopPropagation();
          }
        });

        // TODO How to get the element's coordinates?
        function calculateDirection(element, event) {
          var posx = event.offsetX - element.clientLeft;
          var posy = event.offsetY - element.clientTop;
          var x = posx - element.clientWidth / 2;
          var y = posy - element.clientHeight / 2;
          return Math.atan2(y, x) * (180/Math.PI);
        }
      </script>
    </dom-module>
  </body>
</html>
